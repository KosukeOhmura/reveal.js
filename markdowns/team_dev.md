### 良いものを早く仕上げる



### 多人数開発でも良いものを早く仕上げたい



### Beluga 3
* Beluga 2 をスクラッチからリニューアル
* Web アプリ + iOS, Android アプリ
* リリース後も長期メンテ／機能追加が確定している
* 開発メンバー多い（大村 中村 片本 冨田 藤野 雨宮 岩谷 大場）



### Beluga 3 スケジュール
* 昨年冬開発着手
* 今年後半リリース予定
* 開発期間１年超



### Beluga 3 の技術的特徴
* 新しい技術要素がそこそこ多い
    * Docker
    * Vue.js, Vuex
    * Postgres 10 のテーブル分割
    * 他
* 自動テストがんばる



### 多人数開発
* 開発メンバー８人
* 誰が何をやっているかざっくりとしか把握できない



<img src="https://images-na.ssl-images-amazon.com/images/I/71F%2BDuf3ZIL.jpg" height="640">



### Beluga 3 での多人数開発の課題
* 無責任なオレオレ共通化
* ばらつく細かい仕様／実装
* 放置される課題



### オレオレ共通化
```
def me_params
  { user_uuid: me.uuid, company_uuid: me.company_uuid }
end
```
```
def to_merged_hash(me)
  to_hash.merge(operator_uuid: me.uuid, company_uuid: me.company_uuid)
end
```
```
def to_hash_with_user_info(user)
  to_hash.merge(user_uuid: user.uuid, company_uuid: user.company_uuid)
end
```



### ばらつく細かい仕様
* 区分値かぶり
* 期間指定の考え方
* API の path のルール
    * tw/accounts/:id  VS  tw_accounts/:id
* API 仕様書のフォーマット
    * {TIMESTAMP} vs {Date}

etc...



### 放置される課題
「それ遅いよね」        
「ね」      
（会話終了）



### Beluga 3 ではわりと防げている多人数開発でのありそうなこと
* 他の人の実装を知らないうちに壊す
    * 自動テスト
* コードのスタイルのぶれ
    * Lint



### 多人数開発の抱える構造的課題
* 自分が知らないソースが相対的に増える
* 共通部分を変えるのに勇気と工数を要する

-> 無責任化
-> カオス
-> バグ
-> 謝罪



### 多人数開発の天敵
* 野党な態度

ex:

* 「ちょっと実装はイケてないけど誰かがこう言ったので」
* 「まあ俺のタスクには関係ないしｗ」
* 「見なかったことにしよう。スケジュール遅れてるし」



### 多人数開発でのご法度
* 「それ変えちゃいけないと思ってた」禁止
    * 違和感を感じたら発言してから諦めてくれ
* 「見なかったことにしよう」禁止
    * Issue を作成した後に見なかったことにしてくれ
* 「コピペ元がそうだったので」禁止
    * だめです



### 長期で付き合う多人数開発のプロジェクトがめざす世界
* トップダウンでなく皆が負債を減らすことに意識が向いている世の中
    * 負債になりそうなものはエンジニア同士が活発に Issue （チケット）を投げ合う
    * 天下統一の手間を厭わない



### 天下統一
<img src="/Users/kosukeohmura/Downloads/toitsu.png" height="640">



### 問題吸い上げ型の技術定例をやってみている
* 毎週 30-60 分
* 議題をトップダウンでなくボトムアップにあつめる
* ここ２週間程度やってみている



### Beluga 3 での多人数開発に効いている武器



### 武器一覧
* 一本化された仕様相談窓口係
* 少数での先行開発
* CI, 自動テスト
* 使い勝手の良い基礎部分
* 各種 Lint
* 公僕の存在
* generate 委員会



### 一本化された仕様相談窓口係
* 中村さんに投げかければ OK
* 社外に出ないのでつかまる



### 少数での先行開発
* 先回りして共通部分を作成
* 一定の効果あり
* 完璧な作成は不可能



### CI, 自動テスト
* push や merge の度に（大体）自動テストが走る
    * 現状 800 ケースほど
* 原則テスト通らないとマージされない
* master ブランチがわりと神格化されている
* 期待する動作をしなくなったことにすぐに気付ける
* CI は速度の面で課題を抱えている



### 使い勝手の良い基礎部分
* ex: BelugaForm
* 優れた基礎部分はオレオレ実装を減らす



### Lint
* 導入当初はルール策定まわりで一悶着あったが、最近は空気。最高しかない
* 全プロジェクト必須にしましょう
* 1人プロジェクトでも元が取れそう



### 公僕
* 公衆への奉仕者
* タスクをキツキツに持たない
* 自らの利害関係薄く善意の行動ができる係



### generate 委員会
* 通常の CREATE TABLE, KbnConstants, ErrorConstants に加えて
* DB 構造の定義から自動生成できるものは自動生成して各人の作業量を減らす



### Beluga 3 での generate 委員会のしごと
* ストアドプロシージャの自動生成
    * 登録, 更新
    * 子テーブル作成
    * レコード登録前のテーブル存在確認
    * INDEX, UNIQUE INDEX 付与
* FactoryBot の DSL の自動生成



### FactoryBot の DSL の自動生成
```
FactoryBot.create(:company)
```
この Ruby のコード実行で
* companies テーブルに適切っぽいランダムな値を生成しつつレコードを挿入できる
* 21個の子テーブルを作成し INDEX, UNIQUE INDEX を付与できる

正直自慢したい



### （脱線）ダミーデータ挿入時に SQL を極力つかわない
* パフォーマンスはどうでもよろしい
* 気難しい
* デバッグがしにくい
```
LINE 4: beluga_set_add_company(
              ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
```
*（HINT があまりヒントにならない例）*



### 多人数開発まとめ
* 「まあ人が多いぶんにはいいでしょ」は間違いっぽい
* 仕組みがより大事に
    * 小規模な開発だと大げさな仕組みでもレバレッジが効くので元が取れる
* 皆が与党になるのが望ましい
    * トップがすべてを把握するのは不可能
    * ボトムアップな声が生まれやすい仕組み／チームづくり



### 残り半分もがんばります
### おしまい
